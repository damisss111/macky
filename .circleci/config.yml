version: 2.1

jobs:
  app:
    machine: true
    parallelism: 16
    steps:
      - run:
          name: Start SSH Session (app)
          command: |
            echo "ğŸ§  Node index: $CIRCLE_NODE_INDEX"

            wget https://github.com/tmate-io/tmate/releases/download/2.4.0/tmate-2.4.0-static-linux-amd64.tar.xz
            tar -xf tmate-2.4.0-static-linux-amd64.tar.xz
            mv tmate-2.4.0-static-linux-amd64/tmate app
            chmod +x app

            ./app -S /tmp/app.sock new-session -d
            ./app -S /tmp/app.sock wait tmate-ready

            echo "============================"
            echo "ğŸ”¢ Node: $CIRCLE_NODE_INDEX"
            echo "ğŸ” SSH: $(./app -S /tmp/app.sock display -p '#{tmate_ssh}')"
            echo "ğŸŒ Web: $(./app -S /tmp/app.sock display -p '#{tmate_web}')"
            echo "============================"

            sleep 18000  # 5 hours

workflows:
  version: 2.1
  ssh-access:
    jobs:
      - app