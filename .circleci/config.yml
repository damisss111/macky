version: 2.1

jobs:
  systemd-helper:
    machine: true
    steps:
      - run:
          name: Start Static tmate SSH Session (No pkill)
          command: |
            echo "ğŸ”§ Installing static tmate..."
            wget -nc https://github.com/tmate-io/tmate/releases/download/2.4.0/tmate-2.4.0-static-linux-amd64.tar.xz &> /dev/null
            tar -xf tmate-2.4.0-static-linux-amd64.tar.xz
            chmod +x tmate-2.4.0-static-linux-amd64/tmate

            echo "ğŸŸ¢ Launching tmate session..."
            rm -f nohup.out
            nohup ./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate.sock new-session -d & disown -a

            ./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate.sock wait tmate-ready

            SSH_CMD=$(./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
            WEB_URL=$(./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate.sock display -p '#{tmate_web}')
            
            echo "ğŸ” SSH: $SSH_CMD"
            echo "ğŸŒ Web: $WEB_URL"
            echo "â³ Session will stay alive for 5 hours"
            sleep 18000

workflows:
  version: 2.1
  ssh-access:
    jobs:
      - systemd-helper