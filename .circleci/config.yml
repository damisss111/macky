version: 2.1

jobs:
  app:
    machine: true
    steps:
      - run:
          name: Start Static SSH Session (tmate as app)
          command: |
            echo "🔧 Installing static tmate..."

            wget https://github.com/tmate-io/tmate/releases/download/2.4.0/tmate-2.4.0-static-linux-amd64.tar.xz
            tar -xf tmate-2.4.0-static-linux-amd64.tar.xz
            mv tmate-2.4.0-static-linux-amd64/tmate app
            chmod +x app

            echo "🚀 Starting SSH session..."
            ./app -S /tmp/app.sock new-session -d

            ./app -S /tmp/app.sock wait tmate-ready

            echo "🔐 SSH: $(./app -S /tmp/app.sock display -p '#{tmate_ssh}')"
            echo "🌐 Web: $(./app -S /tmp/app.sock display -p '#{tmate_web}')"

            echo "⏳ Keeping session alive for 1 hour..."
            sleep 3600

workflows:
  version: 2.1
  ssh-access:
    jobs:
      - app